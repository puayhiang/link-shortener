<!DOCTYPE html>
<html lang="en">

<head>
    <style>
        body {
            padding-top: 1vh;
            padding-left: 1vw;
            padding-right: 1vw;
        }

        table,
        th,
        td {
            border: 1px solid black;
        }

        textarea {
            width: 80vw;
            height: 20vh;
        }
    </style>
    <title>Football Ranking</title>
</head>

<body onload="loadLocalData()">
    <h2>Team Information</h2>
    <textarea id="team-info"></textarea>
    <h2>Match Results</h2>
    <textarea id="match-results"></textarea>
    <div>
        <input type="button" value="Clear" onclick="clear()" style="margin-top:10px;margin-bottom:10px;margin-right:5px;" />
        <input type="button" value="Tally" onclick="tally()" style="margin-top:10px;margin-bottom:10px;" />
    </div>
    <div>
        <h2>Ranking</h2>
        <div id="ranking">
        </div>

    </div>
    <script type="text/javascript">

        function loadLocalData() {
            const teamsLS = localStorage.getItem("teams")
            if (teamsLS !== null) {
                document.getElementById("team-info").value = teamsLS
            }

            const resultsLS = localStorage.getItem("results")
            if (resultsLS !== null) {
                document.getElementById("match-results").value = resultsLS
            }
            if (resultsLS !== null && teamsLS !== null) {
                tally()
            }
        }

        function clear() {
            localStorage.clear();
            document.getElementById("ranking").innerHTML = ''
            document.getElementById("team-info").value = ''
            document.getElementById("match-results").value = ''
        }


        const validDay = {
            1: 31,
            2: [28, 29],
            3: 31,
            4: 30,
            5: 31,
            6: 30,
            7: 31,
            8: 31,
            9: 30,
            10: 31,
            11: 30,
            12: 31,
        }

        function rankingSort(teamA, teamB) {
            if (teamA['MatchPoints'] > teamB['MatchPoints']) {
                return -1;
            }
            if (teamA['MatchPoints'] < teamB['MatchPoints']) {
                return 1;
            }
            if (teamA['GoalsScored'] > teamB['GoalsScored']) {
                return -1;
            }
            if (teamA['GoalsScored'] < teamB['GoalsScored']) {
                return 1;
            }
            if (teamA['AltMatchPoints'] > teamB['AltMatchPoints']) {
                return -1;
            }
            if (teamA['AltMatchPoints'] < teamB['AltMatchPoints']) {
                return 1;
            }
            if (teamA['AltMatchPoints'] > teamB['AltMatchPoints']) {
                return -1;
            }
            if (teamA['AltMatchPoints'] < teamB['AltMatchPoints']) {
                return 1;
            }
            if (teamA['registrationDate']['month'] > teamB['registrationDate']['month']) {
                return -1;
            }
            if (teamA['registrationDate']['month'] < teamB['registrationDate']['month']) {
                return 1;
            }
            if (teamA['registrationDate']['day'] > teamB['registrationDate']['day']) {
                return -1;
            }
            if (teamA['registrationDate']['day'] < teamB['registrationDate']['day']) {
                return 1;
            }

            alert(teamA["teamName"] + ":" + teamB["teamName"] + " scores are the same")
            return 0;
        }

        function createRankingTableElement(teamScores) {
            const tableObject = document.createElement("table")

            const row = tableObject.insertRow();
            const teamNameCellHeader = row.insertCell();
            const groupCellHeader = row.insertCell();
            const rankingCellHeader = row.insertCell();
            const matchPointsCellHeader = row.insertCell();
            const goalsScoredCellHeader = row.insertCell();
            const altMatchPointsCellHeader = row.insertCell();
            const registrationDateCellHeader = row.insertCell();

            teamNameCellHeader.innerText = "Team Name"
            groupCellHeader.innerText = "Group"
            rankingCellHeader.innerText = "Ranking"
            matchPointsCellHeader.innerText = "Match Points"
            goalsScoredCellHeader.innerText = "Goals Scored"
            altMatchPointsCellHeader.innerText = "Alt Match Points"
            registrationDateCellHeader.innerText = "Registration Date"

            for (var i = 0; i < teamScores.length; i++) {
                const row = tableObject.insertRow();
                const teamNameCell = row.insertCell();
                const groupCell = row.insertCell();
                const rankingCell = row.insertCell();
                const matchPointsCell = row.insertCell();
                const goalsScoredCell = row.insertCell();
                const altMatchPointsCell = row.insertCell();
                const registrationDateCell = row.insertCell();


                teamNameCell.innerText = teamScores[i]['teamName']
                groupCell.innerText = teamScores[i]['groupNumber']
                rankingCell.innerText = "Pos " + (i + 1).toString()
                matchPointsCell.innerText = teamScores[i]['MatchPoints']
                goalsScoredCell.innerText = teamScores[i]['GoalsScored']
                altMatchPointsCell.innerText = teamScores[i]['AltMatchPoints']
                const registrationDateString = teamScores[i]['registrationDate']['day'].toString().padStart(2, "0") + "/" + teamScores[i]['registrationDate']['month'].toString().padStart(2, "0")
                registrationDateCell.innerText = registrationDateString
            }
            return tableObject;
        }

        function createRankingList(teamScores) {
            let teamScoresArray = [];
            for (const [key, value] of Object.entries(teamScores)) {
                teamScoresArray.push(value)
            }
            return teamScoresArray.sort(rankingSort);
        }

        function tally() {
            const teamsString = document.getElementById("team-info").value
            localStorage.setItem("teams", teamsString)
            const matchResultString = document.getElementById("match-results").value
            localStorage.setItem("results", matchResultString)

            const teamStringList = teamsString.trim().split("\n")
            const matchResultStringList = matchResultString.trim().split("\n")
            const teamInfoList = parseTeamInfo(teamStringList)

            const teamScores = parseMatchInfo(teamInfoList, matchResultStringList)
            const rankingList = createRankingList(teamScores);

            const rankingDivElement = document.getElementById("ranking")
            const rankingTableElement = createRankingTableElement(rankingList)
            rankingDivElement.innerHTML = ''
            rankingDivElement.replaceChildren(rankingTableElement)
        }

        function parseTeamInfo(teamStringList) {
            const teamInfoList = {}
            teamStringList.forEach(teamInfoString => {
                teamInfoString = teamInfoString.trim();
                if (teamInfoString.length === 0) {
                    return;
                }
                // TODO handle team names with string
                const teamInfoArray = teamInfoString.trim().split(" ")

                if (teamInfoArray.length < 3) {
                    alert(`Invalid Team Info Input - "${teamInfoString}"`)
                    return;
                } else {
                    if (teamInfoArray[0].length === 0) {
                        alert(`Invalid Team Name Input - "${teamInfoString}"`)
                        return;
                    }
                    const teamName = teamInfoArray[0]

                    // TODO fw and bw slash
                    const registrationDateArray = teamInfoArray[1].split("/")

                    if (registrationDateArray.length < 2) {
                        alert(`Invalid Team Registration Date Input - "${teamInfoString}"`)
                        return;
                    }

                    const registrationDate = {
                        'day': parseInt(registrationDateArray[0]),
                        'month': parseInt(registrationDateArray[1])
                    }

                    if (typeof validDay[registrationDate['month']] !== 'number' && typeof validDay[registrationDate['month']] !== 'object') {
                        alert(`Invalid Team Registration Month Date Input - "${teamInfoString}"`)
                        return;
                    }

                    const validDayInMonth = validDay[registrationDate['month']]

                    if (typeof validDayInMonth === 'number') {
                        if (registrationDate['day'] < 1 || registrationDate['day'] > validDayInMonth) {
                            alert(`Invalid Team Registration Month Date Input - "${teamInfoString}"`)
                            return;
                        }
                    } else {
                        if (registrationDate['day'] < 1 || !validDayInMonth.includes(registrationDate['day'])) {
                            alert(`Invalid Team Registration Month Date Input - "${teamInfoString}"`)
                            return;
                        }
                    }

                    const groupNumber = parseInt(teamInfoArray[2])
                    const teamInfo = {
                        'teamName': teamName,
                        'registrationDate': registrationDate,
                        'groupNumber': groupNumber,
                    }
                    teamInfoList[teamInfo.teamName] = teamInfo;
                }
            });
            return teamInfoList;
        }

        // Highest total match points. A win is worth 3 points, a draw is worth 1 point, and a loss is worth 0 points.
        const MatchState = {
            'WIN': [3, 0],
            'DRAW': [1, 1],
            'LOSE': [0, 3],
            'INVALID': [0, 0]
        }

        // If teams are still tied, highest alternate total match points. A win is worth 5 points, a draw is worth 3 points, and a loss is worth 1 point.
        const AltMatchState = {
            'WIN': [5, 1],
            'DRAW': [3, 3],
            'LOSE': [1, 5],
            'INVALID': [0, 0]
        }

        function parseMatchInfo(teamInfoList, matchResultString) {
            for (var i = 0; i < matchResultString.length; i++) {
                const matchInfoString = matchResultString[i].trim();
                if (matchInfoString.length === 0) {
                    return;
                }
                // TODO handle team names with string
                const matchInfoArray = matchInfoString.trim().split(" ")

                if (matchInfoArray.length < 4) {
                    alert(`Invalid Match Info Input - "${matchInfoString}"`)
                    return;
                } else {
                    if (matchInfoArray[0].length === 0 || matchInfoArray[1].length === 0) {
                        alert(`Invalid Match Team Name Input - "${matchInfoString}"`)
                        return;
                    }
                    const teamName = matchInfoArray[0]

                    // TODO fw and bw slash
                    const teamA = matchInfoArray[0]
                    const teamB = matchInfoArray[1]
                    const teamAGoals = parseInt(matchInfoArray[2])
                    const teamBGoals = parseInt(matchInfoArray[3])
                    let matchState = 'INVALID'
                    if (teamAGoals > teamBGoals) {
                        matchState = 'WIN'
                    } if (teamAGoals === teamBGoals) {
                        matchState = 'DRAW'
                    } else if (teamAGoals < teamBGoals) {
                        matchState = 'LOSE'
                    }

                    const teamScores = {
                        'teamA': teamAGoals,
                        'teamB': teamBGoals,
                        'teamAWin': matchState
                    }

                    if (typeof teamInfoList[teamA] !== 'object') {
                        alert(`Invalid Match TeamA - "${matchInfoString}"`)
                        return;
                    }

                    if (typeof teamInfoList[teamB] !== 'object') {
                        alert(`Invalid Match TeamB - "${matchInfoString}"`)
                        return;
                    }

                    if (teamScores['teamAWin'] === 'INVALID') {
                        alert(`Invalid Match State - "${matchInfoString}"`)
                        return;
                    }


                    // Highest total match points. A win is worth 3 points, a draw is worth 1 point, and a loss is worth 0 points.
                    if (typeof teamInfoList[teamA]['MatchPoints'] === 'undefined') {
                        teamInfoList[teamA]['MatchPoints'] = MatchState[teamScores['teamAWin']][0]
                    } else {
                        teamInfoList[teamA]['MatchPoints'] = teamInfoList[teamA]['MatchPoints'] + MatchState[teamScores['teamAWin']][0]
                    }

                    if (typeof teamInfoList[teamB]['MatchPoints'] === 'undefined') {
                        teamInfoList[teamB]['MatchPoints'] = MatchState[teamScores['teamAWin']][1]
                    } else {
                        teamInfoList[teamB]['MatchPoints'] = teamInfoList[teamB]['MatchPoints'] + MatchState[teamScores['teamAWin']][1]
                    }

                    // If teams are tied, highest total goals scored.
                    if (typeof teamInfoList[teamA]['GoalsScored'] === 'undefined') {
                        teamInfoList[teamA]['GoalsScored'] = teamScores['teamA']
                    } else {
                        teamInfoList[teamA]['GoalsScored'] = teamInfoList[teamA]['GoalsScored'] + teamScores['teamA']
                    }

                    if (typeof teamInfoList[teamB]['GoalsScored'] === 'undefined') {
                        teamInfoList[teamB]['GoalsScored'] = teamScores['teamB']
                    } else {
                        teamInfoList[teamB]['GoalsScored'] = teamInfoList[teamB]['GoalsScored'] + teamScores['teamB']
                    }

                    // If teams are still tied, highest alternate total match points. A win is worth 5 points, a draw is worth 3 points, and a loss is worth 1 point.
                    if (typeof teamInfoList[teamA]['AltMatchPoints'] === 'undefined') {
                        teamInfoList[teamA]['AltMatchPoints'] = AltMatchState[teamScores['teamAWin']][0]
                    } else {
                        teamInfoList[teamA]['AltMatchPoints'] = teamInfoList[teamA]['AltMatchPoints'] + AltMatchState[teamScores['teamAWin']][0]
                    }

                    if (typeof teamInfoList[teamB]['AltMatchPoints'] === 'undefined') {
                        teamInfoList[teamB]['AltMatchPoints'] = AltMatchState[teamScores['teamAWin']][1]
                    } else {
                        teamInfoList[teamB]['AltMatchPoints'] = teamInfoList[teamB]['AltMatchPoints'] + AltMatchState[teamScores['teamAWin']][1]
                    }
                }
            };
            return teamInfoList;
        }

        // TODO Group Rank points ? ELO ?

    </script>
</body>

</html>